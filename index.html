<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šç‰Œè¾¨è­˜ç³»çµ± (é«˜æº–ç¢ºç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 10px; background: #222; color: white; }
        
        /* è¦–è¨Šå€å¡Š */
        #video-container { 
            position: relative; margin: 0 auto; 
            width: 100%; max-width: 640px; height: 480px; 
            background: #000; overflow: hidden;
        }
        video { 
            width: 100%; height: 100%; object-fit: cover; 
        }
        
        /* ç¶ è‰²æƒææ¡† (å›ºå®šåœ¨ç•«é¢ä¸­å¤®) */
        .scan-region {
            position: absolute; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 280px; height: 80px; /* è¨­å®šè»Šç‰Œå¤§æ¦‚çš„æ¯”ä¾‹ */
            border: 3px solid #00ff00; 
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.3);
            z-index: 10;
        }
        .scan-label {
            position: absolute; top: -25px; left: 0; width: 100%;
            color: #00ff00; font-weight: bold; font-size: 14px;
        }

        /* æ§åˆ¶å€ */
        .controls { margin-top: 20px; }
        button {
            padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px;
            background-color: #007bff; color: white; cursor: pointer; margin: 5px;
        }
        button:disabled { background-color: #555; color: #888; }
        button.scan-btn { background-color: #28a745; font-weight: bold; width: 80%; max-width: 300px; padding: 15px; }

        /* çµæœé¡¯ç¤º */
        #statusMsg { margin: 15px 0; min-height: 1.2em; font-size: 1.1em; color: #aaa; }
        .match-success { color: #0f0; font-size: 1.4em; font-weight: bold; border: 2px solid #0f0; padding: 10px; display:inline-block; }
        .match-fail { color: #f00; font-size: 1.4em; font-weight: bold; border: 2px solid #f00; padding: 10px; display:inline-block;}

        /* Debug è¦–çª—ï¼šé¡¯ç¤ºé›»è…¦çœ‹åˆ°çš„é»‘ç™½ç•«é¢ */
        #debug-container { margin-top: 20px; border-top: 1px solid #444; padding-top: 10px; }
        #processedCanvas { border: 1px solid #666; width: 280px; height: 80px; background: #000; }
        .debug-text { font-size: 12px; color: #888; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h3>ğŸš— è»Šç‰Œè¾¨è­˜ (å½±åƒå¢å¼·ç‰ˆ)</h3>
    <div id="dbStatus" style="font-size: 12px; color: #aaa;">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>

    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <div class="scan-region">
            <div class="scan-label">è«‹å°‡è»Šç‰Œç½®æ–¼æ¡†å…§</div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">1. å•Ÿå‹•ç›¸æ©Ÿ</button>
        <br>
        <button id="scanBtn" class="scan-btn" disabled>ğŸ“¸ ç«‹å³è¾¨è­˜</button>
    </div>

    <div id="statusMsg">ç­‰å¾…æ“ä½œ...</div>

    <div id="debug-container">
        <div class="debug-text">é›»è…¦çœ‹åˆ°çš„å½±åƒ (å¦‚æœå¤ªé»‘æˆ–å¤ªäº®è«‹èª¿æ•´è§’åº¦):</div>
        <canvas id="processedCanvas"></canvas>
    </div>

    <script>
        // è¨­å®š
        let whitelistSet = new Set();
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const statusMsg = document.getElementById('statusMsg');
        const dbStatus = document.getElementById('dbStatus');
        const processedCanvas = document.getElementById('processedCanvas');

        // 1. è¼‰å…¥è³‡æ–™åº« (èˆ‡ä¸Šä¸€ç‰ˆç›¸åŒ)
        async function loadWhitelist() {
            try {
                const response = await fetch('whitelist.txt');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ");
                const text = await response.text();
                const lines = text.split(/\r?\n/);
                lines.forEach(line => {
                    const clean = line.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); // å»é™¤ç¬¦è™Ÿåªç•™è‹±æ•¸
                    if (clean) whitelistSet.add(clean);
                });
                dbStatus.textContent = `âœ… è³‡æ–™åº«ï¼š${whitelistSet.size} ç­†è»Šç‰Œ`;
            } catch (err) {
                dbStatus.textContent = "âŒ è³‡æ–™åº«è¼‰å…¥å¤±æ•— (è«‹æª¢æŸ¥ whitelist.txt)";
            }
        }
        loadWhitelist();

        // 2. å•Ÿå‹•ç›¸æ©Ÿ (ä¿®æ­£ï¼šå¼·åˆ¶å¾Œé¡é ­)
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment", // å¾Œé¡é ­
                        width: { ideal: 1280 },    // ç›¡é‡é«˜ç•«è³ª
                        height: { ideal: 720 }
                    } 
                });
                video.srcObject = stream;
                // ç­‰å¾…å½±ç‰‡çœŸçš„é–‹å§‹æ’­æ”¾
                video.onloadedmetadata = () => {
                    video.play();
                    scanBtn.disabled = false;
                    startBtn.style.display = 'none';
                    statusMsg.textContent = "è«‹å°æº–ç¶ æ¡†ï¼Œä¿æŒæ‰‹æ©Ÿç©©å®š";
                };
            } catch (err) {
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š" + err.message);
            }
        });

        // 3. å½±åƒè™•ç†æ ¸å¿ƒå‡½æ•¸ (é—œéµä¿®æ­£ï¼)
        function captureAndProcessImage() {
            const ctx = processedCanvas.getContext('2d');
            const vw = video.videoWidth;
            const vh = video.videoHeight;

            // è¨ˆç®—è¢å¹•ä¸Šç¶ æ¡†çš„å¯¦éš›æ¯”ä¾‹ä½ç½®
            // é€™è£¡å‡è¨­ç¶ æ¡†æ˜¯è¢å¹•ä¸­å¿ƒï¼Œå¯¬ 280px é«˜ 80px (ç›¸å°æ–¼ 640x480 çš„é¡¯ç¤ºå€)
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ç›´æ¥æŠ“å–ç•«é¢ä¸­å¿ƒé»çš„ä¸€å¡Šå€åŸŸ
            
            // å¯¦éš›æ“·å–å°ºå¯¸ (æ ¹æ“šå½±ç‰‡åŸå§‹è§£æåº¦è¨ˆç®—)
            // å‡è¨­æˆ‘å€‘è¦æŠ“å–ç•«é¢æ­£ä¸­å¤® 50% å¯¬åº¦, 20% é«˜åº¦çš„å€åŸŸ
            const cropW = vw * 0.6; 
            const cropH = cropW * 0.35; // ç¶­æŒè»Šç‰Œé•·å¯¬æ¯”
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            // è¨­å®š Canvas å¤§å°ç­‰æ–¼è£åˆ‡å¤§å°
            processedCanvas.width = cropW;
            processedCanvas.height = cropH;

            // A. è£åˆ‡ä¸¦ç¹ªè£½åˆ° Canvas
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            // B. å½±åƒå¢å¼· (äºŒå€¼åŒ–è™•ç†)
            // å–å¾—åƒç´ è³‡æ–™
            let imageData = ctx.getImageData(0, 0, cropW, cropH);
            let data = imageData.data;

            // éæ­·æ¯å€‹åƒç´ 
            for (let i = 0; i < data.length; i += 4) {
                // è½‰ç°éš
                const gray = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                
                // äºŒå€¼åŒ– (Thresholding): ç°¡å–®çš„å°‡ç°è‰²è½‰ç‚ºç´”é»‘æˆ–ç´”ç™½
                // é–€æª»å€¼ 100 å¯ä»¥æ ¹æ“šç¾å ´äº®åº¦èª¿æ•´ (0~255)
                const threshold = 100; 
                const value = gray > threshold ? 255 : 0;

                data[i] = value;     // R
                data[i + 1] = value; // G
                data[i + 2] = value; // B
                // Alpha ä¸è®Š
            }
            // å°‡è™•ç†å¾Œçš„é»‘ç™½åœ–ç‰‡æ”¾å› Canvas
            ctx.putImageData(imageData, 0, 0);

            // å›å‚³è™•ç†å¥½çš„åœ–ç‰‡ DataURL
            return processedCanvas.toDataURL('image/png');
        }

        // 4. åŸ·è¡Œè¾¨è­˜
        scanBtn.addEventListener('click', async () => {
            statusMsg.textContent = "â³ è™•ç†å½±åƒä¸¦è¾¨è­˜ä¸­...";
            
            // å–å¾—è™•ç†é(é»‘ç™½+è£åˆ‡)çš„åœ–ç‰‡
            const dataUrl = captureAndProcessImage();

            try {
                const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng', {
                    // â˜… é—œéµè¨­å®šï¼šåªå…è¨±è‹±æ•¸å­— â˜…
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
                });

                // æ¸…ç†çµæœ
                let result = text.replace(/[^A-Z0-9]/g, '');

                console.log("è¾¨è­˜åŸå§‹æ–‡å­—:", text);
                console.log("æ¸…ç†å¾Œ:", result);

                if (result.length < 2) {
                    statusMsg.textContent = "âš ï¸ æ²’çœ‹åˆ°æ–‡å­—ï¼Œè«‹èª¿æ•´è§’åº¦æˆ–è·é›¢";
                } else {
                    checkMembership(result);
                }
            } catch (err) {
                console.error(err);
                statusMsg.textContent = "âŒ è¾¨è­˜å¼•æ“éŒ¯èª¤";
            }
        });

        // 5. æ¯”å°çµæœ
        function checkMembership(plate) {
            // å˜—è©¦æ¨¡ç³Šæ¯”å° (ä¾‹å¦‚ O è¾¨è­˜æˆ 0ï¼Œæˆ–å°‘ä¸€å€‹å­—)
            // é€™è£¡å…ˆåšæœ€åš´æ ¼çš„æ¯”å°
            if (whitelistSet.has(plate)) {
                statusMsg.innerHTML = `<span class="match-success">â­• æœƒå“¡ç¢ºèª<br>${plate}</span>`;
            } else {
                // å®¹éŒ¯æª¢æŸ¥ï¼šå¦‚æœè³‡æ–™åº«æœ‰ ABC-1234ï¼Œä½†è¾¨è­˜å‡º ABC1234 (æ²’æ©«ç·š)ï¼Œä¹Ÿè¦ç®—å°
                // å› ç‚ºæˆ‘å€‘åœ¨è¼‰å…¥è³‡æ–™åº«æ™‚å·²ç¶“æŠŠæ©«ç·šå»æ‰äº†ï¼Œæ‰€ä»¥ç›´æ¥æ¯”å°å³å¯
                statusMsg.innerHTML = `<span class="match-fail">âŒ éæœƒå“¡<br>${plate}</span>`;
            }
        }

    </script>
</body>
</html>
