<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šç‰Œè¾¨è­˜ (ç©åˆ†æŠ•ç¥¨ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 10px; background: #000; color: white; }
        
        #video-container { 
            position: relative; margin: 0 auto; 
            width: 100%; max-width: 640px; height: 400px;
            background: #111; overflow: hidden; border-radius: 12px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* æƒææ¡†ï¼šäº®ç¶ è‰²å¯¦ç·šï¼Œå¢åŠ å°æ¯” */
        .scan-region {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 80%; height: 30%; 
            border: 3px solid #00ff00; border-radius: 8px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6);
            z-index: 10;
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #00ff00; top: 0;
            animation: scanMove 2s infinite linear;
            box-shadow: 0 0 4px #00ff00;
        }
        @keyframes scanMove { 0% {top: 0;} 50% {top: 100%;} 100% {top: 0;} }

        .controls { margin-top: 15px; }
        button {
            padding: 12px 24px; font-size: 16px; border: none; border-radius: 50px;
            background-color: #444; color: white; cursor: pointer; margin: 5px;
        }
        button.scan-btn { background-color: #28a745; width: 80%; font-size: 1.2em; font-weight: bold; }
        button:disabled { background-color: #222; color: #555; }

        /* çµæœé¡¯ç¤ºå€ */
        #result-area { margin-top: 15px; padding: 15px; background: #222; border-radius: 12px; min-height: 80px; }
        .candidate-box { font-size: 0.9em; color: #888; margin-bottom: 5px; height: 20px; }
        .match-success { color: #4dff4d; font-size: 2em; font-weight: 900; text-shadow: 0 0 10px rgba(0,255,0,0.5); }
        .match-fail { color: #ff4d4d; font-size: 1.5em; font-weight: bold; }
        
        /* é€²åº¦æ¢ (é¡¯ç¤ºä¿¡å¿ƒæŒ‡æ•¸) */
        #confidence-bar-container {
            width: 80%; height: 10px; background: #444; margin: 10px auto; border-radius: 5px; overflow: hidden;
        }
        #confidence-bar {
            width: 0%; height: 100%; background: #00ff00; transition: width 0.2s;
        }

        #processedCanvas { display: none; } /* éš±è—é™¤éŒ¯åœ–ï¼Œä¿æŒä»‹é¢ä¹¾æ·¨ */
    </style>
</head>
<body>

    <h3>ğŸ›¡ï¸ è»Šç‰Œè¾¨è­˜ (é˜²æŠ–å‹•èˆ‡éæ¿¾)</h3>
    <div id="dbStatus" style="font-size: 12px; color: #aaa;">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>

    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <div class="scan-region">
            <div class="scan-line"></div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
        <br>
        <button id="scanBtn" class="scan-btn" disabled>ğŸ“¸ é–‹å§‹é€£çºŒæƒæ</button>
    </div>

    <div id="result-area">
        <div id="candidateMsg" class="candidate-box">æ­£åœ¨æœå°‹...</div>
        <div id="confidence-bar-container">
            <div id="confidence-bar"></div>
        </div>
        <div id="statusMsg" style="margin-top:10px; font-size:1.2em; color:white;">ç­‰å¾…æ“ä½œ</div>
    </div>

    <canvas id="processedCanvas"></canvas>

    <script>
        // è¨­å®šèˆ‡è®Šæ•¸
        let whitelistArray = [];
        let isScanning = false;
        
        // â˜… æ ¸å¿ƒè®Šæ•¸ï¼šå€™é¸æ±  â˜…
        // ç”¨ä¾†å„²å­˜æœ€è¿‘å¹¾æ¬¡è¾¨è­˜åˆ°çš„çµæœï¼Œè¨ˆç®—é‡è¤‡æ¬¡æ•¸
        let votePool = {}; 
        const VOTE_THRESHOLD = 3; // éœ€è¦é€£çºŒç´¯ç© 3 åˆ†æ‰ç®—ç¢ºèª
        const POOL_RESET_TIME = 2000; // 2ç§’æ²’æ–°çš„çµæœå°±æ¸…ç©ºç©åˆ†

        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const statusMsg = document.getElementById('statusMsg');
        const candidateMsg = document.getElementById('candidateMsg');
        const confidenceBar = document.getElementById('confidence-bar');
        const dbStatus = document.getElementById('dbStatus');
        const processedCanvas = document.getElementById('processedCanvas');

        // æ˜“æ··æ·†å­—å…ƒè¡¨ (ç¶­æŒä½¿ç”¨ï¼Œè§£æ±º 6 vs 4)
        const CONFUSABLE_MAP = {
            '4': ['6', 'A'], '6': ['4', 'G', '8', '0'], 'Z': ['2', '7'], '2': ['Z'],
            'B': ['8', 'D'], '8': ['B', '3'], 'D': ['0', 'O', 'Q'], '0': ['D', 'O', 'Q'],
            'O': ['0', 'D', 'Q'], 'Q': ['0', 'D', 'O'], 'S': ['5'], '5': ['S']
        };

        // 1. è¼‰å…¥è³‡æ–™åº«
        async function loadWhitelist() {
            try {
                const response = await fetch('whitelist.txt');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ");
                const text = await response.text();
                whitelistArray = text.split(/\r?\n/)
                    .map(line => line.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase())
                    .filter(item => item.length > 0);
                dbStatus.textContent = `âœ… è³‡æ–™åº«ï¼š${whitelistArray.length} ç­†è³‡æ–™`;
            } catch (err) {
                dbStatus.textContent = "âŒ è³‡æ–™åº«è¼‰å…¥å¤±æ•—";
            }
        }
        loadWhitelist();

        // 2. ç›¸æ©Ÿæ§åˆ¶
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => { video.play(); scanBtn.disabled = false; startBtn.style.display = 'none'; };
            } catch (err) { alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ"); }
        });

        // 3. å½±åƒå„ªåŒ– (è£åˆ‡ + è‡ªå‹•è‰²éš)
        function captureAndProcessImage() {
            const ctx = processedCanvas.getContext('2d');
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            // ç¸®å°ç¯„åœå°ˆæ³¨ä¸­å¤® (å¯¬ 70%, é«˜ 25%) æ¸›å°‘è²¼ç´™å¹²æ“¾
            const cropW = vw * 0.7; 
            const cropH = cropW * 0.35; 
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            processedCanvas.width = cropW;
            processedCanvas.height = cropH;
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            let imageData = ctx.getImageData(0, 0, cropW, cropH);
            let data = imageData.data;
            
            // è‡ªå‹•è‰²éš (Auto Levels)
            let min = 255, max = 0;
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                if (gray < min) min = gray;
                if (gray > max) max = gray;
            }
            if (max === min) max = min + 1;

            for (let i = 0; i < data.length; i += 4) {
                let gray = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                let normalized = (gray - min) / (max - min) * 255;
                // äºŒå€¼åŒ–ï¼Œé–€æª»è¨­ç‚º 140 (åäº®éƒ¨åˆ†è½‰ç™½ï¼Œå…¶ä»–è½‰é»‘)
                let value = normalized > 140 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            return processedCanvas.toDataURL('image/png');
        }

        // 4. æ¨¡ç³Šæ¯”å°æ¼”ç®—æ³•
        function isFuzzyMatch(scanned, dbItem) {
            if (Math.abs(scanned.length - dbItem.length) > 1) return false;
            let errors = 0;
            let i = 0, j = 0;
            while (i < scanned.length && j < dbItem.length) {
                if (scanned[i] === dbItem[j]) { i++; j++; }
                else if (CONFUSABLE_MAP[dbItem[j]]?.includes(scanned[i])) { i++; j++; } // å¯å®¹å¿çš„éŒ¯èª¤
                else { errors++; i++; j++; }
            }
            return errors <= 1; // å…è¨±æœ€å¤šéŒ¯ 1 å€‹å­— (ä¸”ä¸æ˜¯æ˜“æ··æ·†å­—)
        }

        // 5. æƒæèˆ‡æŠ•ç¥¨é‚è¼¯
        async function startScanningLoop() {
            if (isScanning) return;
            isScanning = true;
            scanBtn.textContent = "ğŸ›‘ æƒæä¸­...";
            scanBtn.style.backgroundColor = "#dc3545";
            statusMsg.textContent = "è«‹ç©©å®šæ¡æŒæ‰‹æ©Ÿ...";

            while (isScanning) {
                const dataUrl = captureAndProcessImage();
                
                try {
                    // åŸ·è¡Œ OCR
                    const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng', {
                        tessedit_pageseg_mode: '7', // å–®è¡Œæ¨¡å¼
                        tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789- '
                    });

                    // æ¸…ç†é›œè¨Šï¼šåªç•™è‹±æ•¸
                    // ä½¿ç”¨æ­£å‰‡éæ¿¾ï¼šå¿…é ˆåŒ…å«è‡³å°‘ 2 å€‹å­—æ¯å’Œ 2 å€‹æ•¸å­— (æ’é™¤ç´”æ¨™èª)
                    let rawTokens = text.split(/[\s\n]+/);
                    
                    let frameCandidates = [];

                    // é€™ä¸€è¼ªç•«é¢ä¸­æ‰¾åˆ°çš„æ‰€æœ‰æ½›åœ¨è»Šç‰Œ
                    rawTokens.forEach(token => {
                        let clean = token.replace(/[^A-Z0-9]/g, '');
                        // å°ç£è»Šç‰Œé•·åº¦é‚è¼¯ (4~8ç¢¼) ä¸” å¿…é ˆæœ‰æ•¸å­—
                        if (clean.length >= 4 && clean.length <= 8 && /[0-9]/.test(clean)) {
                            frameCandidates.push(clean);
                        }
                    });

                    if (frameCandidates.length > 0) {
                        const topCandidate = frameCandidates[0]; // å–æœ€åƒçš„ä¸€å€‹
                        candidateMsg.textContent = `åµæ¸¬åˆ°ï¼š${topCandidate}`;
                        
                        // --- ç©åˆ†é‚è¼¯ Start ---
                        // 1. æª¢æŸ¥é€™å€‹çµæœæ˜¯å¦åœ¨è³‡æ–™åº« (å«æ¨¡ç³Šæ¯”å°)
                        let matchedMember = null;
                        for (let member of whitelistArray) {
                            if (isFuzzyMatch(topCandidate, member)) {
                                matchedMember = member; // æ‰¾åˆ°äº†ï¼é€™æ˜¯æˆ‘å€‘è³‡æ–™åº«çš„äºº
                                break;
                            }
                        }

                        if (matchedMember) {
                            // 2. åŠ åˆ†
                            if (!votePool[matchedMember]) votePool[matchedMember] = 0;
                            votePool[matchedMember]++;
                            
                            // æ›´æ–° UI é¡¯ç¤ºä¿¡å¿ƒåº¦
                            let confidence = (votePool[matchedMember] / VOTE_THRESHOLD) * 100;
                            confidenceBar.style.width = `${Math.min(confidence, 100)}%`;

                            // 3. åˆ¤æ–·æ˜¯å¦éé—œ
                            if (votePool[matchedMember] >= VOTE_THRESHOLD) {
                                statusMsg.innerHTML = `<div class="match-success">â­• é–‹é–€ï¼<br>${matchedMember}</div>`;
                                // é€™è£¡å¯ä»¥å‘¼å« API é–‹é–€
                                isScanning = false; // åœæ­¢æƒæ
                                scanBtn.textContent = "âœ… è¾¨è­˜æˆåŠŸ (é»æ“Šé‡è¨­)";
                                scanBtn.style.backgroundColor = "#28a745";
                            } else {
                                statusMsg.textContent = `ç¢ºèªä¸­ (${votePool[matchedMember]}/${VOTE_THRESHOLD})...`;
                            }
                        } else {
                            // æƒåˆ°äº†æ–‡å­—ï¼Œä½†ä¸æ˜¯æœƒå“¡ -> å¯èƒ½æ˜¯é›œè¨Šæˆ–éæœƒå“¡
                            statusMsg.textContent = "âŒ éæœƒå“¡æˆ–è®€å–ä¸­...";
                            // æ…¢æ…¢æ‰£åˆ† (é¿å…é›œè¨Šä¸€ç›´ä½”è‘—ç©åˆ†)
                            for (let key in votePool) {
                                if (votePool[key] > 0) votePool[key]--;
                            }
                            confidenceBar.style.width = "0%";
                        }
                        // --- ç©åˆ†é‚è¼¯ End ---

                    } else {
                        candidateMsg.textContent = "...";
                    }

                } catch (err) {
                    console.error(err);
                }

                // ç¨å¾®æš«åœä¸€ä¸‹ï¼Œé¿å…éç†±
                await new Promise(r => setTimeout(r, 200));
            }
        }

        scanBtn.addEventListener('click', () => {
            if (isScanning) {
                // å¦‚æœå·²ç¶“åœ¨æƒï¼Œé»æ“Šå‰‡æ˜¯é‡è¨­
                isScanning = false;
                votePool = {}; // æ¸…ç©ºç©åˆ†
                confidenceBar.style.width = "0%";
                statusMsg.textContent = "å·²æš«åœ";
                scanBtn.textContent = "ğŸ“¸ é–‹å§‹é€£çºŒæƒæ";
                scanBtn.style.backgroundColor = "#28a745";
                scanBtn.disabled = false;
            } else {
                startScanningLoop();
            }
        });

        // å®šæ™‚æ¸…ç©ºéæœŸç©åˆ† (å¦‚æœæ‹¿é–‹æ‰‹æ©Ÿï¼Œç©åˆ†è¦æ­¸é›¶)
        setInterval(() => {
            if (!isScanning) return;
            // é€™è£¡å¯ä»¥åšç°¡å–®çš„è¡°é€€é‚è¼¯
            // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘ä¾è³´ä¸Šé¢çš„æ‰£åˆ†é‚è¼¯
        }, 1000);

    </script>
</body>
</html>
