<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šç‰Œè¾¨è­˜ç³»çµ± (æ™ºæ…§å®¹éŒ¯ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 10px; background: #222; color: white; }
        
        #video-container { 
            position: relative; margin: 0 auto; 
            width: 100%; max-width: 640px; height: 400px; 
            background: #000; overflow: hidden; border-radius: 8px;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* æƒææ¡†ï¼šèª¿æ•´ç‚ºæ›´æ‰é•·ï¼Œç¬¦åˆè»Šç‰Œæ¯”ä¾‹ */
        .scan-region {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 70%; height: 15%; /* ç¸®å°ç¯„åœä»¥æ¸›å°‘é›œè¨Š */
            border: 2px solid #00ff00; 
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* è®“æ¡†æ¡†å¤–è®Šæš—ï¼Œå°ˆæ³¨æ¡†å…§ */
            z-index: 10;
        }
        .scan-label {
            position: absolute; top: -30px; left: 0; width: 100%;
            color: #00ff00; font-weight: bold; font-size: 14px; text-shadow: 1px 1px 2px black;
        }

        .controls { margin-top: 15px; }
        button {
            padding: 12px 20px; font-size: 16px; border: none; border-radius: 8px;
            background-color: #007bff; color: white; cursor: pointer; margin: 5px;
        }
        button:disabled { background-color: #555; color: #888; }
        button.scan-btn { background-color: #28a745; font-weight: bold; width: 60%; padding: 15px; font-size: 1.2em; }

        #result-area { margin-top: 15px; padding: 10px; background: #333; border-radius: 8px; min-height: 80px; }
        .ocr-raw { color: #888; font-size: 0.9em; margin-bottom: 5px; }
        
        .match-success { color: #2fff2f; font-size: 1.5em; font-weight: 900; animation: pop 0.3s ease; }
        .match-fail { color: #ff4d4d; font-size: 1.5em; font-weight: 900; }
        @keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }

        /* é™¤éŒ¯å€ */
        #debug-container { margin-top: 20px; border-top: 1px dashed #555; padding-top: 10px; display: flex; justify-content: center;}
        #processedCanvas { border: 1px solid #666; width: 200px; height: auto; background: #000; }
    </style>
</head>
<body>

    <h3>ğŸš— æœƒå“¡è»Šç‰Œè¾¨è­˜ (æ™ºæ…§å®¹éŒ¯ç‰ˆ)</h3>
    <div id="dbStatus" style="font-size: 12px; color: #aaa;">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>

    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <div class="scan-region">
            <div class="scan-label">è«‹å°‡è»Šç‰Œå‰›å¥½æ”¾å…¥æ¡†å…§</div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
        <br>
        <button id="scanBtn" class="scan-btn" disabled>ğŸ“¸ è¾¨è­˜</button>
    </div>

    <div id="result-area">
        <div id="ocrRaw" class="ocr-raw">åŸå§‹è®€å–ï¼š-</div>
        <div id="statusMsg">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div id="debug-container">
        <div>
            <div style="font-size:10px; color:#aaa; margin-bottom:5px;">é›»è…¦çœ‹åˆ°çš„å½±åƒ (äºŒå€¼åŒ–):</div>
            <canvas id="processedCanvas"></canvas>
        </div>
    </div>

    <script>
        // è¨­å®š
        let whitelistArray = []; // æ”¹ç”¨ Array ä»¥ä¾¿é€²è¡Œéæ­·æœå°‹
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const statusMsg = document.getElementById('statusMsg');
        const ocrRawMsg = document.getElementById('ocrRaw');
        const dbStatus = document.getElementById('dbStatus');
        const processedCanvas = document.getElementById('processedCanvas');

        // 1. è¼‰å…¥è³‡æ–™åº«
        async function loadWhitelist() {
            try {
                const response = await fetch('whitelist.txt');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ");
                const text = await response.text();
                const lines = text.split(/\r?\n/);
                whitelistArray = lines
                    .map(line => line.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase()) // æ¸…ç†è³‡æ–™
                    .filter(item => item.length > 0); // ç§»é™¤ç©ºè¡Œ
                
                dbStatus.textContent = `âœ… å·²è¼‰å…¥ ${whitelistArray.length} ç­†æœƒå“¡è³‡æ–™`;
            } catch (err) {
                dbStatus.textContent = "âŒ è³‡æ–™åº«è¼‰å…¥å¤±æ•—";
            }
        }
        loadWhitelist();

        // 2. å•Ÿå‹•ç›¸æ©Ÿ
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    scanBtn.disabled = false;
                    startBtn.style.display = 'none';
                    statusMsg.textContent = "æº–å‚™å°±ç·’";
                };
            } catch (err) {
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼š" + err.message);
            }
        });

        // 3. å½±åƒè™•ç† (å„ªåŒ–è£åˆ‡ç¯„åœ)
        function captureAndProcessImage() {
            const ctx = processedCanvas.getContext('2d');
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            
            // ç¸®å°è®€å–ç¯„åœï¼šåªè®€å–ç•«é¢æ­£ä¸­å¤® 50% å¯¬, 15% é«˜
            // ç¯„åœè¶Šå°ï¼Œé›œè¨Šè¶Šå°‘
            const cropW = vw * 0.5; 
            const cropH = cropW * 0.3; // æ‰é•·å‹
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            processedCanvas.width = cropW;
            processedCanvas.height = cropH;

            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            let imageData = ctx.getImageData(0, 0, cropW, cropH);
            let data = imageData.data;

            // äºŒå€¼åŒ–è™•ç†
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                const value = gray > 110 ? 255 : 0; // ç¨å¾®æé«˜å°æ¯”é–€æª»
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            return processedCanvas.toDataURL('image/png');
        }

        // 4. è¾¨è­˜èˆ‡æ™ºæ…§æ¯”å°
        scanBtn.addEventListener('click', async () => {
            statusMsg.textContent = "â³ é‹ç®—ä¸­...";
            ocrRawMsg.textContent = "";
            
            const dataUrl = captureAndProcessImage();

            try {
                const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
                });

                // å–å¾—åŸå§‹é›œäº‚çš„çµæœï¼Œä¾‹å¦‚ "10423763440TTT"
                const dirtyResult = text.replace(/[^A-Z0-9]/g, ''); 
                ocrRawMsg.textContent = `åŸå§‹è¾¨è­˜ï¼š${dirtyResult}`;

                if (dirtyResult.length < 3) {
                    statusMsg.textContent = "âš ï¸ æ²’çœ‹åˆ°è»Šç‰Œï¼Œè«‹é è¿‘ä¸€é»";
                    return;
                }

                // â˜… æ ¸å¿ƒé­”æ³•ï¼šåå‘åŒ…å«æœå°‹ â˜…
                // æª¢æŸ¥ã€Œè³‡æ–™åº«è£¡çš„æ­£ç¢ºè»Šè™Ÿã€æ˜¯å¦ã€Œèº²åœ¨ã€é€™ä¸²äº‚ç¢¼è£¡é¢
                let foundMember = null;
                
                for (let memberPlate of whitelistArray) {
                    // å¦‚æœæœƒå“¡è»Šè™Ÿ (ä¾‹å¦‚ ABC1234) è¢«åŒ…å«åœ¨ äº‚ç¢¼ (1ABC1234TT) è£¡é¢
                    if (dirtyResult.includes(memberPlate)) {
                        foundMember = memberPlate;
                        break; // æ‰¾åˆ°äº†å°±åœæ­¢
                    }
                }

                // é¡¯ç¤ºçµæœ
                if (foundMember) {
                    statusMsg.innerHTML = `<div class="match-success">â­• æ­¡è¿æœƒå“¡<br>${foundMember}</div>`;
                } else {
                    statusMsg.innerHTML = `<div class="match-fail">âŒ æœªæ‰¾åˆ°æœƒå“¡è³‡æ–™</div>`;
                }

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "âŒ ç³»çµ±éŒ¯èª¤";
            }
        });
    </script>
</body>
</html>
