<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šç‰Œè¾¨è­˜ç³»çµ± (å°ç£å„ªåŒ–ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 10px; background: #1a1a1a; color: white; }
        
        #video-container { 
            position: relative; margin: 0 auto; 
            width: 100%; max-width: 640px; height: 450px; /* æ‹‰é«˜ç•«é¢ */
            background: #000; overflow: hidden; border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* --- ä¿®æ­£å¾Œçš„æƒææ¡† --- */
        .scan-region {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            /* å°ç£è»Šç‰Œæ¯”ä¾‹ç´„ç‚º 38x16 (æ±½è»Š) æˆ– 26x15 (æ©Ÿè»Š) */
            /* é€™è£¡è¨­å®šä¸€å€‹é€šç”¨çš„ å¯¬é«˜æ¯”ï¼Œç´„ 2.5 : 1 */
            width: 85%; 
            height: 25%; 
            border: 4px solid #00ff00; 
            border-radius: 8px;
            /* è®“æ¡†æ¡†å¤–è®Šæš— (é®ç½©æ•ˆæœ) */
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); 
            z-index: 10;
        }
        /* å¢åŠ å››å€‹è§’è½çš„æ¨™è¨˜ï¼Œè®“å°ç„¦æ›´å®¹æ˜“ */
        .scan-region::after, .scan-region::before {
            content: ''; position: absolute; width: 20px; height: 20px; border-color: #00ff00; border-style: solid;
        }
        .scan-region::before { top: -2px; left: -2px; border-width: 4px 0 0 4px; }
        .scan-region::after { bottom: -2px; right: -2px; border-width: 0 4px 4px 0; }

        .scan-label {
            position: absolute; top: -35px; left: 0; width: 100%;
            color: #00ff00; font-weight: bold; font-size: 16px; text-shadow: 2px 2px 4px black;
            background: rgba(0,0,0,0.5); padding: 4px 0; border-radius: 4px;
        }

        .controls { margin-top: 15px; }
        button {
            padding: 12px 24px; font-size: 18px; border: none; border-radius: 8px;
            background-color: #007bff; color: white; cursor: pointer; margin: 8px;
            box-shadow: 0 4px 0 #0056b3; transition: 0.1s;
        }
        button:active { transform: translateY(4px); box-shadow: 0 0 0; }
        button:disabled { background-color: #555; color: #888; box-shadow: none; transform: none; }
        button.scan-btn { background-color: #28a745; width: 70%; padding: 18px; font-size: 1.3em; box-shadow: 0 4px 0 #1e7e34; }

        #result-area { margin-top: 15px; padding: 15px; background: #333; border-radius: 10px; min-height: 100px; }
        .ocr-raw { color: #aaa; font-size: 0.9em; margin-bottom: 8px; font-family: monospace; }
        
        .match-success { color: #4dff4d; font-size: 1.6em; font-weight: 900; line-height: 1.4; text-shadow: 0 0 10px rgba(0,255,0,0.3); }
        .match-fail { color: #ff4d4d; font-size: 1.6em; font-weight: 900; }

        /* é™¤éŒ¯å€ï¼šç¸®å°ä¸€é»é¿å…ä½”ç©ºé–“ */
        #debug-container { margin-top: 20px; border-top: 1px dashed #555; padding-top: 10px; }
        #processedCanvas { border: 1px solid #666; width: 180px; height: auto; background: #000; display: block; margin: 0 auto; }
    </style>
</head>
<body>

    <h3>ğŸ‡¹ğŸ‡¼ å°ç£è»Šç‰Œè¾¨è­˜ç³»çµ±</h3>
    <div id="dbStatus" style="font-size: 12px; color: #aaa;">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>

    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <div class="scan-region">
            <div class="scan-label">å°‡è»Šç‰Œç½®æ–¼æ¡†å…§ (æ”¯æ´æ±½æ©Ÿè»Š)</div>
        </div>
    </div>

    <div class="controls">
        <button id="startBtn">1. å•Ÿå‹•ç›¸æ©Ÿ</button>
        <br>
        <button id="scanBtn" class="scan-btn" disabled>ğŸ“¸ è¾¨è­˜è»Šç‰Œ</button>
    </div>

    <div id="result-area">
        <div id="ocrRaw" class="ocr-raw">åŸå§‹è®€å–ï¼š-</div>
        <div id="statusMsg">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <div id="debug-container">
        <div style="font-size:10px; color:#aaa; margin-bottom:5px;">é›»è…¦åˆ¤å®šå½±åƒ:</div>
        <canvas id="processedCanvas"></canvas>
    </div>

    <script>
        let whitelistArray = []; 
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const statusMsg = document.getElementById('statusMsg');
        const ocrRawMsg = document.getElementById('ocrRaw');
        const dbStatus = document.getElementById('dbStatus');
        const processedCanvas = document.getElementById('processedCanvas');

        // 1. è¼‰å…¥è³‡æ–™åº« (ç¶­æŒä¸è®Š)
        async function loadWhitelist() {
            try {
                const response = await fetch('whitelist.txt');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ");
                const text = await response.text();
                // é€™è£¡æœƒæŠŠè³‡æ–™åº«çš„è»Šè™Ÿä¹Ÿæ¸…ç†ä¹¾æ·¨ (å»æ‰æ©«ç·š)
                whitelistArray = text.split(/\r?\n/)
                    .map(line => line.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase())
                    .filter(item => item.length > 0);
                
                dbStatus.textContent = `âœ… è³‡æ–™åº«å°±ç·’ï¼š${whitelistArray.length} ç­†è³‡æ–™`;
            } catch (err) {
                dbStatus.textContent = "âŒ è³‡æ–™åº«è¼‰å…¥å¤±æ•—";
            }
        }
        loadWhitelist();

        // 2. å•Ÿå‹•ç›¸æ©Ÿ (ç¶­æŒä¸è®Š)
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    scanBtn.disabled = false;
                    startBtn.style.display = 'none';
                    statusMsg.textContent = "è«‹å°æº–è»Šç‰Œ";
                };
            } catch (err) {
                alert("ç›¸æ©ŸéŒ¯èª¤ï¼š" + err.message);
            }
        });

        // 3. å½±åƒè™•ç† (é…åˆæ–°æ¡†æ¡†èª¿æ•´è£åˆ‡)
        function captureAndProcessImage() {
            const ctx = processedCanvas.getContext('2d');
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            
            // æ ¹æ“š CSS çš„æ¡†æ¡†æ¯”ä¾‹èª¿æ•´è£åˆ‡å€åŸŸ
            // å¯¬åº¦ 85%, é«˜åº¦ 25%
            const cropW = vw * 0.85; 
            const cropH = cropW * 0.35; // ä¿æŒç´„ 1:3 çš„æ¯”ä¾‹
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            processedCanvas.width = cropW;
            processedCanvas.height = cropH;

            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            let imageData = ctx.getImageData(0, 0, cropW, cropH);
            let data = imageData.data;

            // å¼·åŒ–å°æ¯”åº¦ (äºŒå€¼åŒ–)
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                // ç¨å¾®æé«˜é–€æª»å€¼ä»¥éæ¿¾æ·ºè‰²é›œè¨Š
                const value = gray > 100 ? 255 : 0; 
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            return processedCanvas.toDataURL('image/png');
        }

        // â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šæ¨¡ç³Šä¿®æ­£å™¨ â˜…
        // é€™æœƒç”¢ç”Ÿã€Œå¯èƒ½çš„è»Šç‰Œè®Šé«”ã€ï¼Œè§£æ±º Z/2, O/0 æ··æ·†å•é¡Œ
        function getFuzzyCandidates(text) {
            let candidates = [text]; // åŸå§‹æ–‡å­—ç®—ç¬¬ä¸€å€‹å€™é¸äºº
            
            // å¦‚æœæ–‡å­—ä¸­æœ‰æ˜“æ··æ·†å­—å…ƒï¼Œç”¢ç”Ÿä¿®æ­£ç‰ˆ
            // ä¾‹å¦‚: "AZZ5678" -> "A225678"
            
            // è¦å‰‡ 1: æ•¸å­—æ··æ·†ä¿®æ­£ (æŠŠåƒæ•¸å­—çš„è‹±æ–‡è½‰å›æ•¸å­—)
            let fixNums = text
                .replace(/Z/g, '2')
                .replace(/O/g, '0')
                .replace(/D/g, '0')
                .replace(/Q/g, '0')
                .replace(/B/g, '8')
                .replace(/S/g, '5')
                .replace(/I/g, '1')
                .replace(/L/g, '1');
            
            if (fixNums !== text) candidates.push(fixNums);

            // è¦å‰‡ 2 (åå‘): å¦‚æœè»Šç‰Œæ˜¯ ABC é–‹é ­ï¼Œæœ‰æ™‚æœƒè¢«èª¤åˆ¤æˆæ•¸å­—
            // (ä¾‹å¦‚ 4BC -> ABC)ï¼Œé€™è£¡è¦–æ‚¨çš„è»Šç‰Œé¡å‹è€Œå®šï¼Œæš«æ™‚å…ˆä¸åŠ ï¼Œé¿å…èª¤åˆ¤ã€‚

            return candidates;
        }

        // 4. è¾¨è­˜èˆ‡é‚è¼¯
        scanBtn.addEventListener('click', async () => {
            statusMsg.textContent = "â³ åˆ†æä¸­...";
            ocrRawMsg.textContent = "";
            const dataUrl = captureAndProcessImage();

            try {
                const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng', {
                    tessedit_char_whitelist: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'
                });

                // 1. æ¸…ç†åŸå§‹é›œè¨Š
                const dirtyResult = text.replace(/[^A-Z0-9]/g, ''); 
                
                if (dirtyResult.length < 3) {
                    statusMsg.textContent = "âš ï¸ å½±åƒä¸æ¸…ï¼Œè«‹å†è©¦ä¸€æ¬¡";
                    return;
                }

                // 2. ç”¢ç”Ÿä¿®æ­£å¾Œçš„å€™é¸å­—ä¸² (ä¾‹å¦‚å°‡ Z è½‰ç‚º 2)
                const candidates = getFuzzyCandidates(dirtyResult);
                
                // é¡¯ç¤ºé™¤éŒ¯è¨Šæ¯
                ocrRawMsg.innerHTML = `åŸå§‹: ${dirtyResult}<br>ä¿®æ­£å˜—è©¦: ${candidates.join(', ')}`;

                // 3. æ¯”å°è³‡æ–™åº«
                let foundMember = null;
                
                // é›™é‡è¿´åœˆæ¯”å°ï¼š
                // æª¢æŸ¥æ¯ä¸€å€‹ã€Œè³‡æ–™åº«è»Šè™Ÿã€æ˜¯å¦å‡ºç¾åœ¨ã€Œä»»ä½•ä¸€å€‹å€™é¸å­—ä¸²ã€ä¸­
                for (let candidate of candidates) {
                    for (let memberPlate of whitelistArray) {
                        if (candidate.includes(memberPlate)) {
                            foundMember = memberPlate;
                            break;
                        }
                    }
                    if (foundMember) break;
                }

                if (foundMember) {
                    statusMsg.innerHTML = `<div class="match-success">â­• æ­¡è¿æœƒå“¡<br>${foundMember}</div>`;
                    // å¯ä»¥åœ¨é€™è£¡åŠ å…¥èªéŸ³: new Audio('success.mp3').play();
                } else {
                    statusMsg.innerHTML = `<div class="match-fail">âŒ éæœƒå“¡<br>${dirtyResult}</div>`;
                }

            } catch (err) {
                console.error(err);
                statusMsg.textContent = "âŒ éŒ¯èª¤";
            }
        });
    </script>
</body>
</html>
