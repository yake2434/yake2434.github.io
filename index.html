<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è»Šç‰Œè¾¨è­˜ (å¿«é€Ÿç©©å®šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 10px; background: #000; color: white; }
        
        #video-container { 
            position: relative; margin: 0 auto; 
            width: 100%; max-width: 640px; height: 360px;
            background: #111; overflow: hidden; border-radius: 8px; border: 1px solid #444;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* æƒææ¡† */
        .scan-region {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            width: 75%; height: 30%; 
            border: 3px solid #00ff00; border-radius: 6px;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.6); /* èšå…‰ç‡ˆæ•ˆæœ */
            z-index: 10;
        }

        .controls { margin-top: 15px; }
        button {
            padding: 12px 24px; font-size: 16px; border: none; border-radius: 50px;
            background-color: #444; color: white; cursor: pointer; margin: 5px;
        }
        button.scan-btn { background-color: #28a745; width: 85%; font-size: 1.2em; font-weight: bold; }
        button:disabled { background-color: #222; color: #555; }

        #result-area { margin-top: 15px; padding: 15px; background: #222; border-radius: 12px; }
        .match-success { color: #4dff4d; font-size: 1.8em; font-weight: 900; }
        
        /* ä¿¡å¿ƒé€²åº¦æ¢ */
        #confidence-wrapper { width: 80%; height: 10px; background: #444; margin: 10px auto; border-radius: 5px; overflow: hidden; }
        #confidence-bar { width: 0%; height: 100%; background: #00ff00; transition: width 0.1s; }

        /* éš±è—ç•«å¸ƒ */
        #processedCanvas { display: none; }
    </style>
</head>
<body>

    <h3>ğŸ›¡ï¸ è»Šç‰Œè¾¨è­˜ (é€£çºŒ2æ¬¡ç¢ºèª)</h3>
    <div id="dbStatus" style="font-size: 12px; color: #aaa;">è³‡æ–™åº«è¼‰å…¥ä¸­...</div>

    <div id="video-container">
        <video id="video" playsinline autoplay muted></video>
        <div class="scan-region"></div>
    </div>

    <div class="controls">
        <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
        <br>
        <button id="scanBtn" class="scan-btn" disabled>ğŸ“¸ é–‹å§‹æƒæ</button>
    </div>

    <div id="result-area">
        <div id="candidateMsg" style="color:#aaa; font-size:0.9em; height:20px;">---</div>
        <div id="confidence-wrapper"><div id="confidence-bar"></div></div>
        <div id="statusMsg" style="margin-top:10px; font-size:1.2em;">ç­‰å¾…æ“ä½œ</div>
    </div>

    <canvas id="processedCanvas"></canvas>

    <script>
        // === è¨­å®šå€ ===
        const VOTE_THRESHOLD = 2; // â˜… è¨­å®šç‚º 2 æ¬¡å°±é€šé
        // =============

        let whitelistArray = [];
        let isScanning = false;
        let votePool = {}; 
        
        const video = document.getElementById('video');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const statusMsg = document.getElementById('statusMsg');
        const candidateMsg = document.getElementById('candidateMsg');
        const confidenceBar = document.getElementById('confidence-bar');
        const dbStatus = document.getElementById('dbStatus');
        const processedCanvas = document.getElementById('processedCanvas');

        // å…§å»ºçš„æ˜“æ··æ·†å°ç…§è¡¨ (6=4, Z=2, B=8)
        const CONFUSABLE_MAP = {
            '4': ['6', 'A'], '6': ['4', 'G', '8', '0', 'B'], 
            'Z': ['2', '7'], '2': ['Z'],
            'B': ['8', 'D', '0', '6'], '8': ['B', '3', 'S', '6'],
            'D': ['0', 'O', 'Q'], '0': ['D', 'O', 'Q'], 'O': ['0', 'D', 'Q'],
            'S': ['5'], '5': ['S'],
            'I': ['1'], '1': ['I', 'T']
        };

        // 1. è¼‰å…¥è³‡æ–™åº«
        async function loadWhitelist() {
            try {
                const response = await fetch('whitelist.txt');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ°æª”æ¡ˆ");
                const text = await response.text();
                whitelistArray = text.split(/\r?\n/)
                    .map(line => line.trim().replace(/[^a-zA-Z0-9]/g, '').toUpperCase())
                    .filter(item => item.length > 0);
                dbStatus.textContent = `âœ… è³‡æ–™åº«å·²è¼‰å…¥ï¼š${whitelistArray.length} ç­†`;
            } catch (err) {
                dbStatus.textContent = "âŒ whitelist.txt è®€å–å¤±æ•—";
            }
        }
        loadWhitelist();

        // 2. å•Ÿå‹•ç›¸æ©Ÿ
        startBtn.addEventListener('click', async () => {
            try {
                // è«‹æ±‚ç›¸æ©Ÿæ¬Šé™
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } 
                });
                video.srcObject = stream;
                
                // ç¢ºä¿å½±ç‰‡çœŸçš„é–‹å§‹æ’­æ”¾æ‰å•Ÿç”¨æŒ‰éˆ•
                video.onloadedmetadata = () => {
                    video.play();
                    scanBtn.disabled = false;
                    startBtn.style.display = 'none';
                    statusMsg.textContent = "ç›¸æ©Ÿå·²å•Ÿå‹•ï¼Œè«‹é»æ“Šé–‹å§‹æƒæ";
                };
            } catch (err) {
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿï¼è«‹ç¢ºèªç¶²å€æ˜¯ HTTPS æˆ–æ˜¯ä½¿ç”¨ localhostã€‚éŒ¯èª¤è¨Šæ¯ï¼š" + err.message);
            }
        });

        // 3. å½±åƒè™•ç† (è‡ªå‹•å°æ¯”åº¦ä¿®æ­£)
        function captureAndProcessImage() {
            const ctx = processedCanvas.getContext('2d');
            const vw = video.videoWidth;
            const vh = video.videoHeight;
            
            // è£åˆ‡ç•«é¢ä¸­å¤® (å¯¬ 75%, é«˜ 30%)
            const cropW = vw * 0.75; 
            const cropH = cropW * 0.30; 
            const cropX = (vw - cropW) / 2;
            const cropY = (vh - cropH) / 2;

            processedCanvas.width = cropW;
            processedCanvas.height = cropH;
            ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

            let imageData = ctx.getImageData(0, 0, cropW, cropH);
            let data = imageData.data;
            
            // ç°¡å–®çš„äº®åº¦å¢å¼·æ¼”ç®—æ³•
            for (let i = 0; i < data.length; i += 4) {
                const gray = data[i] * 0.3 + data[i + 1] * 0.59 + data[i + 2] * 0.11;
                // äºŒå€¼åŒ–ï¼šå¤§æ–¼ 110 è®Šå…¨ç™½ï¼Œå°æ–¼è®Šå…¨é»‘
                const value = gray > 110 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = value;
            }
            ctx.putImageData(imageData, 0, 0);
            return processedCanvas.toDataURL('image/png');
        }

        // 4. å®¹éŒ¯æ¯”å°æ ¸å¿ƒ
        function isFuzzyMatch(scanned, dbItem) {
            // é•·åº¦æª¢æŸ¥ (å…è¨±å·® 1 ç¢¼)
            if (Math.abs(scanned.length - dbItem.length) > 1) return false;

            let errors = 0;
            let i = 0, j = 0;
            while (i < scanned.length && j < dbItem.length) {
                if (scanned[i] === dbItem[j]) {
                    // å­—å…ƒç›¸åŒï¼Œç¹¼çºŒ
                    i++; j++;
                } else if (
