<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è»Šç‰Œè¾¨è­˜ç³»çµ± (TXTç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
        #video-container { position: relative; margin: 0 auto; max-width: 100%; width: 640px; }
        video { width: 100%; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 100px; border: 2px solid #00ff00; box-shadow: 0 0 20px rgba(0,255,0,0.2);
            z-index: 10; pointer-events: none;
        }
        .controls { margin-top: 20px; }
        button {
            padding: 12px 24px; font-size: 18px; border: none; border-radius: 50px;
            background-color: #007bff; color: white; cursor: pointer; margin: 5px;
        }
        button:disabled { background-color: #ccc; }
        button.scan-btn { background-color: #28a745; }
        #result-area { margin-top: 20px; padding: 15px; background: white; border-radius: 8px; }
        .status { font-weight: bold; margin-top: 10px; font-size: 1.1em; }
        .match-success { color: #28a745; font-size: 1.5em; font-weight: 900; }
        .match-fail { color: #dc3545; font-size: 1.5em; font-weight: 900; }
        input { font-size: 18px; padding: 8px; width: 150px; text-transform: uppercase; text-align: center; }
        .db-info { color: #666; font-size: 0.9em; margin-bottom: 15px; }
    </style>
</head>
<body>

    <h2>ğŸš— æœƒå“¡è»Šç‰Œè¾¨è­˜ (é›¢ç·šç‰ˆ)</h2>
    <div id="dbStatus" class="db-info">æ­£åœ¨è¼‰å…¥æœƒå“¡åå–®...</div>

    <div id="video-container">
        <video id="video" playsinline autoplay></video>
        <div class="overlay"></div>
    </div>
    
    <canvas id="canvas" style="display:none;"></canvas>

    <div class="controls">
        <button id="startBtn">å•Ÿå‹•ç›¸æ©Ÿ</button>
        <button id="scanBtn" class="scan-btn" disabled>ğŸ“¸ æƒæä¸¦æ¯”å°</button>
    </div>

    <div id="result-area">
        <p>è¾¨è­˜çµæœï¼š<input type="text" id="manualInput" placeholder="OCRçµæœ"></p>
        <button onclick="checkMembership()">ğŸ” æ‰‹å‹•æŸ¥è©¢</button>
        <div id="statusMsg" class="status">ç­‰å¾…æ“ä½œ...</div>
    </div>

    <script>
        // è®Šæ•¸è¨­å®š
        let whitelistSet = new Set(); // ä½¿ç”¨ Set çµæ§‹ï¼Œæ¯”å°é€Ÿåº¦æœ€å¿«
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const startBtn = document.getElementById('startBtn');
        const scanBtn = document.getElementById('scanBtn');
        const statusMsg = document.getElementById('statusMsg');
        const manualInput = document.getElementById('manualInput');
        const dbStatus = document.getElementById('dbStatus');

        // 1. ç¶²é é–‹å•Ÿæ™‚ï¼Œç«‹åˆ»è®€å– txt æª”æ¡ˆ
        async function loadWhitelist() {
            try {
                // é€™è£¡è®€å–åŒç›®éŒ„ä¸‹çš„ whitelist.txt
                const response = await fetch('whitelist.txt');
                if (!response.ok) throw new Error("æ‰¾ä¸åˆ° whitelist.txt æª”æ¡ˆ");
                
                const text = await response.text();
                
                // å°‡æ–‡å­—æª”ä¾æ“šæ›è¡Œç¬¦è™Ÿåˆ‡å‰²ï¼Œä¸¦æ¸…ç†ç©ºç™½èˆ‡è½‰å¤§å¯«
                const lines = text.split(/\r?\n/);
                lines.forEach(line => {
                    const cleanPlate = line.trim().toUpperCase();
                    if (cleanPlate) {
                        whitelistSet.add(cleanPlate); // åŠ å…¥è³‡æ–™åº«
                    }
                });

                dbStatus.textContent = `âœ… æœƒå“¡è³‡æ–™åº«å·²è¼‰å…¥ï¼šå…± ${whitelistSet.size} ç­†è³‡æ–™`;
                console.log("è³‡æ–™åº«è¼‰å…¥æˆåŠŸ", whitelistSet);
            } catch (err) {
                console.error(err);
                dbStatus.innerHTML = `<span style="color:red">âš ï¸ è³‡æ–™åº«è¼‰å…¥å¤±æ•—ï¼š${err.message}<br>(è«‹ç¢ºèªæ‚¨æ˜¯ç”¨ä¼ºæœå™¨æ¨¡å¼é–‹å•Ÿï¼Œè€Œéç›´æ¥é»å…©ä¸‹ html æª”æ¡ˆ)</span>`;
            }
        }
        
        // åŸ·è¡Œè¼‰å…¥
        loadWhitelist();

        // 2. å•Ÿå‹•ç›¸æ©Ÿ
        startBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                scanBtn.disabled = false;
                startBtn.style.display = 'none';
                statusMsg.textContent = "è«‹å°‡è»Šç‰Œå°æº–ç¶ æ¡†";
            } catch (err) {
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€ç‚º https æˆ– localhost");
            }
        });

        // 3. æƒæèˆ‡è¾¨è­˜
        scanBtn.addEventListener('click', async () => {
            statusMsg.textContent = "ğŸ”„ å½±åƒè¾¨è­˜ä¸­...";
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const dataUrl = canvas.toDataURL('image/png');

            try {
                const { data: { text } } = await Tesseract.recognize(dataUrl, 'eng');
                // ç§»é™¤éè‹±æ•¸å­—å…ƒ
                const cleanText = text.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();
                
                if (cleanText.length < 2) {
                    statusMsg.textContent = "âš ï¸ ç•«é¢æ¨¡ç³Šï¼Œè«‹é‡è©¦";
                } else {
                    manualInput.value = cleanText;
                    checkMembership(cleanText);
                }
            } catch (err) {
                statusMsg.textContent = "âŒ è¾¨è­˜éŒ¯èª¤";
            }
        });

        // 4. æ¯”å°é‚è¼¯ (ä¿®æ”¹ç‚ºè®€å–æœ¬åœ° Set)
        function checkMembership(plateNumber = null) {
            const queryPlate = plateNumber || manualInput.value.toUpperCase();
            
            if (!queryPlate) {
                alert("è«‹è¼¸å…¥è»Šç‰Œ");
                return;
            }

            // ç›´æ¥åœ¨è¨˜æ†¶é«”ä¸­æ¯”å°ï¼Œé€Ÿåº¦æ¥µå¿«
            if (whitelistSet.has(queryPlate)) {
                statusMsg.innerHTML = `<div class="match-success">â­• é€šé<br>è»Šè™Ÿ ${queryPlate} æ˜¯æœƒå“¡</div>`;
                // é€™è£¡å¯ä»¥æ’­æ”¾æˆåŠŸéŸ³æ•ˆ
            } else {
                statusMsg.innerHTML = `<div class="match-fail">âŒ æ””æˆª<br>è»Šè™Ÿ ${queryPlate} éæœƒå“¡</div>`;
            }
        }
    </script>
</body>
</html>